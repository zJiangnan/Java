package com.softeem;

import java.awt.Color;
import java.awt.Font;
import java.awt.Insets;
import java.awt.RenderingHints.Key;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.security.KeyPair;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.swing.*;
import javax.swing.text.DefaultCaret;

import com.alibaba.fastjson.JSONObject;

public class RobotFrame extends JFrame implements ActionListener {
	
	String appTitle = "????????????";
	JLabel title;			//????
	JTextArea showBox;		//?????????
	JTextArea inputBox;		//?????????
	JButton btnSend;		//??????
	JButton btnClear;		//?????
	
//	???????
	public void initUI(){
		setLayout(null);
		title = new JLabel(appTitle);					//??????
		title.setBounds(0, 0, 600, 40);					//????λ??
		title.setHorizontalAlignment(JLabel.CENTER);	//????
		title.setFont(new Font("????", Font.BOLD, 30));  //???????????
		add(title);
		
//		????????????
		showBox = new JTextArea();
//		????????????
		showBox.setEditable(false);
//		??????????
		showBox.setBackground(new Color(250,250,250));
//		????????
		showBox.setMargin(new Insets(5, 5, 5, 5));
//		?????????(????????????????????)
		DefaultCaret dc = (DefaultCaret)showBox.getCaret();
		dc.setUpdatePolicy(DefaultCaret.ALWAYS_UPDATE);
//		??????????????????
		JScrollPane jp = new JScrollPane(showBox);
//		???ù?????????
		jp.setBounds(20, 60, 560, 350);
//		?????????????????
		jp.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_NEVER);
		add(jp);
		
//		?????????????
		inputBox = new JTextArea();
		inputBox.setFont(new Font("????", Font.PLAIN, 16));
		inputBox.setMargin(new Insets(5, 5, 5, 5));
//		?????????(????????????????????)
		dc = (DefaultCaret)inputBox.getCaret();
		dc.setUpdatePolicy(DefaultCaret.ALWAYS_UPDATE);
//		??????????????????
		JScrollPane jp2 = new JScrollPane(inputBox);
//		???ù?????????
		jp2.setBounds(20, 430, 560, 150);
//		?????????????????
		jp2.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED);
		add(jp2);
		
//		??????
		btnSend = new JButton("????");
//		?????С
		btnSend.setBounds(380, 600, 200, 40);
//		???????
		btnSend.setFont(new Font("????",Font.PLAIN,20));
//		???????
		btnSend.setActionCommand("send");
		add(btnSend);
		
//		?????
		btnClear = new JButton("???");
//		?????С
		btnClear.setBounds(160, 600, 200, 40);
//		???????
		btnClear.setFont(new Font("????",Font.PLAIN,20));
//		???????
		btnClear.setActionCommand("clear");
		add(btnClear);
		
//		????????????
		btnClear.addActionListener(this);
		btnSend.addActionListener(this);
		
//		????????????? ?????????
		inputBox.addKeyListener(new KeyAdapter() {

			@Override
			public void keyPressed(KeyEvent e) {
				if(e.getKeyCode() == KeyEvent.VK_ENTER){
					sendMsg();								//???????????????
					super.keyPressed(e);
				}
			}
		});
	}
	
//	?????????????
	@Override
	public void actionPerformed(ActionEvent e) {
		String cmd = e.getActionCommand();
		if("send".equals(cmd)){
			sendMsg();						//??????????????÷???????????
		}
		else if("clear".equals(cmd)){
			boolean flag = JOptionPane.showConfirmDialog
					(this, "???????", "??????", JOptionPane.YES_OPTION)==0;
			if(flag){
				showBox.setText("");
			}
		}
	}
	
//	???????
	public void sendMsg(){
//		?????????е?????
		String msg = inputBox.getText();
//		???????????
		if("".equals(msg.trim())){
			JOptionPane.showMessageDialog(this, "???????????!");
			return;
		}
//		??????????????
		showBox.append(format("???",msg));
//		????????????
		inputBox.setText("\b");
//		????????????????
		String back = requestRobot(msg);
//		?????????????????????
		showBox.append(format("????",back));
		
		inputBox.setText("");
		inputBox.setCaretPosition(0);
	}
	
//	???????????
	public String requestRobot(String msg){
		String back = null;
//		????????????
//		??????????????
		String key = "1a0e3a1969043992298f2d81d8e47689";
//		???????????
		String secret = "q5r0kk7n9fiq";
//		???????λ??
		String path = "http://i.itpk.cn/api.php";
//		????????UTF-8???
		try {
			msg = URLEncoder.encode(msg,"utf-8");
//			http://i.itpk.cn/api.php?question=??????&api_key=???????&api_secret=???????
			String url=path+"?question="+msg+"&api_key="+key+"&api_secret="+secret;
			URL request = new URL(url);
//			??????
			HttpURLConnection conn = (HttpURLConnection)
					request.openConnection();
			
//			?????????
			conn.setRequestMethod("GET");
//			????????????????
			int code = conn.getResponseCode();
//			code == 200 ??????????????????
			if(code ==200){
//				InputStream  ?????????(????????????????????)
				InputStream is = conn.getInputStream();
//				??????????????????????????????
				InputStreamReader isr = new InputStreamReader(is,"utf-8");
//				????? ??ζ????????
				BufferedReader br = new BufferedReader(isr);
				StringBuffer buffer = new StringBuffer();//????????
				
				String line = null;
				
				while((line = br.readLine()) != null){
					buffer.append(line+"\n");
				}
				back = buffer.toString().substring(1);
//				??????????ison?????????
				JSONObject json = null;
				if(back != null && back.contains("{")){
//					json??????????????????
					json = JSONObject.parseObject(back);
				}
				if(msg.contains(URLEncoder.encode("Ц??","utf-8"))){
//					title???Ц??????
					String title = json.getString("title");
//					content???Ц??????
					String content = json.getString("content");
//					?滻???о?????????? ???????????仰?????
					content.replaceAll("??", "??\n");
					back = "????:\n"+title+"\n????\n"+content;
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		return back;
	}
	
	public String format(String sender,String content){
//		??????
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
		String time = sdf.format(new Date());
		return "["+time+"]   "+sender+":\n"+content+"\n\n";
	}
	
//	???????
	public static void main(String[] args) {
//		????????
		RobotFrame frame = new RobotFrame();
//		????
		frame.setTitle("????????");
//		????????С
		frame.setSize(600, 700);
//		???????
		frame.setLocationRelativeTo(null);
//		??????????С
		frame.setResizable(false);
//		????????
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
//		???????
		frame.setVisible(true);
//		???????????
		frame.initUI();
	}

}	
